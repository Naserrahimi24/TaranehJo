const artistSongs = {
    moein: [
        { title: "Ø¯Ù„ Ø¯ÛŒÙˆÙˆÙ†Ù‡", src: "songs/moein/del-divoone.mp3", art: "images/moein.jpg" },
        { title: "Ø¨ÛŒØ§ Ø¨Ù†ÙˆÛŒØ³ÛŒÙ…", src: "songs/moein/bia-benevisim.mp3", art: "images/moein.jpg" }
    ],
    googoosh: [
        { title: "Ù‡Ù…Ø±Ø§Ù‡", src: "songs/googoosh/hamrah.mp3", art: "images/googoosh.jpg" }
    ],
    ebi: [
        { title: "Ø´Ø¨", src: "songs/ebi/shab.mp3", art: "images/ebi.jpg" }
    ],
    mahasti: [
        { title: "Ø¯Ù„ Ú©ÙˆÚ†Ú© Ù…Ù†", src: "songs/mahasti/del-kuchak.mp3", art: "images/mahasti.jpg" }
    ],
    hayedeh: [
        { title: "Ø³ÙˆØºØ§ØªÛŒ", src: "songs/hayedeh/soghati.mp3", art: "images/hayedeh.jpg" }
    ],
    chavoshi: [
        { title: "Ù‚Ø§ÛŒÙ… Ø¨Ø§Ø´Ú©", src: "songs/chavoshi/ghayem-bashak.mp3", art: "images/chavoshi.jpg" }
    ],
    hamim: [
        { title: "Ø±Ø² Ù…Ø´Ú©ÛŒ", src: "songs/hamim/roz-meshki.mp3", art: "images/hamim.jpg" }
    ],
    ghomayshi: [
        { title: "Ù¾Ø±Ù†Ø¯Ù‡", src: "songs/ghomayshi/parandeh.mp3", art: "images/ghomayshi.jpg" }
    ],
    yeganeh: [
        { title: "Ø¨Ù‡Øª Ù‚ÙˆÙ„ Ù…ÛŒØ¯Ù…", src: "songs/yeganeh/behet-ghol-midam.mp3", art: "images/yeganeh.jpg" }
    ],
    sattar: [
        { title: "Ù‡Ù…Ø§ÛŒÙˆÙ†", src: "songs/sattar/homayoun.mp3", art: "images/sattar.jpg" }
    ],
    aslani: [
        { title: "Ø¯ÛŒÙˆØ§Ø±", src: "songs/aslani/divar.mp3", art: "images/aslani.jpg" }
    ],
    shadmehr: [
        { title: "Ù¾Ø± Ù¾Ø±ÙˆØ§Ø²", src: "songs/shadmehr/par-parvaz.mp3", art: "images/shadmehr.jpg" }
    ],
    ragheb: [
        { title: "Ø¢ÙˆØ§Ø²", src: "songs/ragheb/avaz.mp3", art: "images/ragheb.jpg" }
    ],
    hamidhirad: [
        { title: "Ú¯ÙØªÙ… Ø¨Ù…Ø§Ù†", src: "songs/hamidhirad/goftam-beman.mp3", art: "images/hamidhirad.jpg" }
    ],
    dariush: [
        { title: "Ú†Ø´Ù…Ù‡", src: "songs/dariush/cheshmeh.mp3", art: "images/dariush.jpg" }
    ],
    ehsankhajehamiri: [
        { title: "Ø¹Ø§Ø´Ù‚ Ø´Ø¯Ù†", src: "songs/ehsankhajehamiri/ashogh-shodan.mp3", art: "images/ehsankhajehamiri.jpg" }
    ],
    rezasadeghi: [
        { title: "Ø¨ÛŒ ØªÙˆ", src: "songs/rezasadeghi/bi-to.mp3", art: "images/rezasadeghi.jpg" }
    ],
    sirvankhosravi: [
        { title: "Ø¯ÙˆØ³Øª Ø¯Ø§Ø±Ù… Ø²Ù†Ø¯Ú¯ÛŒ Ø±Ùˆ", src: "songs/sirvankhosravi/doost-daram-zendegi-ro.mp3", art: "images/sirvankhosravi.jpg" }
    ],
    benyaminbahadori: [
        { title: "Ø¹Ø´Ù‚ Ø¯Ø± Ú¯Ø°Ø±", src: "songs/benyaminbahadori/eshgh-dar-gozar.mp3", art: "images/benyaminbahadori.jpg" }
    ],
    farzadfarzin: [
        { title: "Ù†ÙØ³", src: "songs/farzadfarzin/nafas.mp3", art: "images/farzadfarzin.jpg" }
    ],
    maziarfallahi: [
        { title: "Ù„ÛŒÙ„Ø§", src: "songs/maziarfallahi/leila.mp3", art: "images/maziarfallahi.jpg" }
    ],
    mehdi_yarrahi: [
        { title: "Ø¯ÛŒÙˆØ§Ø±", src: "songs/mehdi_yarrahi/divar.mp3", art: "images/mehdi_yarrahi.jpg" }
    ],
    aliabdolmaleki: [
        { title: "Ù†ÙØ³ Ù†ÙØ³", src: "songs/aliabdolmaleki/nafas-nafas.mp3", art: "images/aliabdolmaleki.jpg" }
    ],
    babakjahanbakhsh: [
        { title: "Ù…Ù† Ùˆ Ø¨Ø§Ø±ÙˆÙ†", src: "songs/babakjahanbakhsh/man-o-baroon.mp3", art: "images/babakjahanbakhsh.jpg" }
    ],
    mortezapashaei: [
        { title: "ÛŒÚ©ÛŒ Ù‡Ø³Øª", src: "songs/mortezapashaei/yeki-hast.mp3", art: "images/mortezapashaei.jpg" }
    ],
    behnambani: [
        { title: "Ù‚Ø±Øµ Ù‚Ù…Ø±", src: "songs/behnambani/ghors-ghamar.mp3", art: "images/behnambani.jpg" }
    ],
    bandari: [
        { title: "Ø¢Ù‡Ù†Ú¯ Ø¨Ù†Ø¯Ø±ÛŒ Û±", src: "songs/bandari/1.mp3", art: "images/bandari.jpg" },
        { title: "Ø¢Ù‡Ù†Ú¯ Ø¨Ù†Ø¯Ø±ÛŒ Û²", src: "songs/bandari/2.mp3", art: "images/bandari.jpg" }
    ],
    balochi: [
        { title: "Ø¢Ù‡Ù†Ú¯ Ø¨Ù„ÙˆÚ†ÛŒ Û±", src: "songs/balochi/1.mp3", art: "images/balochi.jpg" },
        { title: "Ø¢Ù‡Ù†Ú¯ Ø¨Ù„ÙˆÚ†ÛŒ Û²", src: "songs/balochi/2.mp3", art: "images/balochi.jpg" }
    ],
    bastaki: [
        { title: "Ø¢Ù‡Ù†Ú¯ Ø¨Ø³ØªÚ©ÛŒ Û±", src: "songs/bastaki/1.mp3", art: "images/bastaki.jpg" },
        { title: "Ø¢Ù‡Ù†Ú¯ Ø¨Ø³ØªÚ©ÛŒ Û²", src: "songs/bastaki/2.mp3", art: "images/bastaki.jpg" }
    ],
    shirazi: [
        { title: "Ø¢Ù‡Ù†Ú¯ Ø´ÛŒØ±Ø§Ø²ÛŒ Û±", src: "songs/shirazi/1.mp3", art: "images/shirazi.jpg" },
        { title: "Ø¢Ù‡Ù†Ú¯ Ø´ÛŒØ±Ø§Ø²ÛŒ Û²", src: "songs/shirazi/2.mp3", art: "images/shirazi.jpg" }
    ],
    shomali: [
        { title: "Ø¢Ù‡Ù†Ú¯ Ø´Ù…Ø§Ù„ÛŒ Û±", src: "songs/shomali/1.mp3", art: "images/shomali.jpg" },
        { title: "Ø¢Ù‡Ù†Ú¯ Ø´Ù…Ø§Ù„ÛŒ Û²", src: "songs/shomali/2.mp3", art: "images/shomali.jpg" }
    ],
    kordi: [
        { title: "Ø¢Ù‡Ù†Ú¯ Ú©Ø±Ø¯ÛŒ Û±", src: "songs/kordi/1.mp3", art: "images/kordi.jpg" },
        { title: "Ø¢Ù‡Ù†Ú¯ Ú©Ø±Ø¯ÛŒ Û²", src: "songs/kordi/2.mp3", art: "images/kordi.jpg" }
    ],
    lori: [
        { title: "Ø¢Ù‡Ù†Ú¯ Ù„Ø±ÛŒ Û±", src: "songs/lori/1.mp3", art: "images/lori.jpg" },
        { title: "Ø¢Ù‡Ù†Ú¯ Ù„Ø±ÛŒ Û²", src: "songs/lori/2.mp3", art: "images/lori.jpg" }
    ],
    gilaki: [
        { title: "Ø¢Ù‡Ù†Ú¯ Ú¯ÛŒÙ„Ú©ÛŒ Û±", src: "songs/gilaki/1.mp3", art: "images/gilaki.jpg" },
        { title: "Ø¢Ù‡Ù†Ú¯ Ú¯ÛŒÙ„Ú©ÛŒ Û²", src: "songs/gilaki/2.mp3", art: "images/gilaki.jpg" }
    ],
    mazandarani: [
        { title: "Ø¢Ù‡Ù†Ú¯ Ù…Ø§Ø²Ù†Ø¯Ø±Ø§Ù†ÛŒ Û±", src: "songs/mazandarani/1.mp3", art: "images/mazandarani.jpg" },
        { title: "Ø¢Ù‡Ù†Ú¯ Ù…Ø§Ø²Ù†Ø¯Ø±Ø§Ù†ÛŒ Û²", src: "songs/mazandarani/2.mp3", art: "images/mazandarani.jpg" }
    ],
    turkmeni: [
        { title: "Ø¢Ù‡Ù†Ú¯ ØªØ±Ú©Ù…Ù†ÛŒ Û±", src: "songs/turkmeni/1.mp3", art: "images/turkmeni.jpg" },
        { title: "Ø¢Ù‡Ù†Ú¯ ØªØ±Ú©Ù…Ù†ÛŒ Û²", src: "songs/turkmeni/2.mp3", art: "images/turkmeni.jpg" }
    ],
    azari: [
        { title: "Ø¢Ù‡Ù†Ú¯ Ø¢Ø°Ø±ÛŒ Û±", src: "songs/azari/1.mp3", art: "images/azari.jpg" },
        { title: "Ø¢Ù‡Ù†Ú¯ Ø¢Ø°Ø±ÛŒ Û²", src: "songs/azari/2.mp3", art: "images/azari.jpg" }
    ],
    khorasani: [
        { title: "Ø¢Ù‡Ù†Ú¯ Ø®Ø±Ø§Ø³Ø§Ù†ÛŒ Û±", src: "songs/khorasani/1.mp3", art: "images/khorasani.jpg" },
        { title: "Ø¢Ù‡Ù†Ú¯ Ø®Ø±Ø§Ø³Ø§Ù†ÛŒ Û²", src: "songs/khorasani/2.mp3", art: "images/khorasani.jpg" }
    ],
    kermani: [
        { title: "Ø¢Ù‡Ù†Ú¯ Ú©Ø±Ù…Ø§Ù†ÛŒ Û±", src: "songs/kermani/1.mp3", art: "images/kermani.jpg" },
        { title: "Ø¢Ù‡Ù†Ú¯ Ú©Ø±Ù…Ø§Ù†ÛŒ Û²", src: "songs/kermani/2.mp3", art: "images/kermani.jpg" }
    ],
    sistani: [
        { title: "Ø¢Ù‡Ù†Ú¯ Ø³ÛŒØ³ØªØ§Ù†ÛŒ Û±", src: "songs/sistani/1.mp3", art: "images/sistani.jpg" },
        { title: "Ø¢Ù‡Ù†Ú¯ Ø³ÛŒØ³ØªØ§Ù†ÛŒ Û²", src: "songs/sistani/2.mp3", art: "images/sistani.jpg" }
    ],
    yazdi: [
        { title: "Ø¢Ù‡Ù†Ú¯ ÛŒØ²Ø¯ÛŒ Û±", src: "songs/yazdi/1.mp3", art: "images/yazdi.jpg" },
        { title: "Ø¢Ù‡Ù†Ú¯ ÛŒØ²Ø¯ÛŒ Û²", src: "songs/yazdi/2.mp3", art: "images/yazdi.jpg" }
    ],
    esfahani: [
        { title: "Ø¢Ù‡Ù†Ú¯ Ø§ØµÙÙ‡Ø§Ù†ÛŒ Û±", src: "songs/esfahani/1.mp3", art: "images/esfahani.jpg" },
        { title: "Ø¢Ù‡Ù†Ú¯ Ø§ØµÙÙ‡Ø§Ù†ÛŒ Û²", src: "songs/esfahani/2.mp3", art: "images/esfahani.jpg" }
    ],
    bakhtiari: [
        { title: "Ø¢Ù‡Ù†Ú¯ Ø¨Ø®ØªÛŒØ§Ø±ÛŒ Û±", src: "songs/bakhtiari/1.mp3", art: "images/bakhtiari.jpg" },
        { title: "Ø¢Ù‡Ù†Ú¯ Ø¨Ø®ØªÛŒØ§Ø±ÛŒ Û²", src: "songs/bakhtiari/2.mp3", art: "images/bakhtiari.jpg" }
    ]
};

// Audio player setup
const audio = new Audio();
let currentPlaylist = [];
let currentTrackIndex = 0;
let currentArtistName = '';
const searchContainer = document.createElement('div');
searchContainer.className = 'search-suggestions hidden absolute bg-gray-800 rounded-lg shadow-lg z-20 max-h-60 overflow-y-auto';
searchContainer.style.width = '100%';
searchContainer.style.maxWidth = '300px';
document.querySelector('.search-bar').appendChild(searchContainer);

// Page load animation
window.addEventListener('load', () => {
    setTimeout(() => {
        document.getElementById('loading-overlay').classList.add('hidden');
        loadPlayerState();
    }, 1000);
});

// Function to toggle sidebar with floating position
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const header = document.querySelector('header');
    const headerRect = header.getBoundingClientRect();

    sidebar.classList.toggle('hidden');
    sidebar.classList.toggle('active');

    if (sidebar.classList.contains('active')) {
        sidebar.style.position = 'fixed';
        sidebar.style.top = `${headerRect.bottom + window.pageYOffset}px`;
        sidebar.style.right = '1rem';
        sidebar.style.width = '80%';
        sidebar.style.maxWidth = '320px';
        sidebar.style.zIndex = '30';
        sidebar.style.backgroundColor = document.body.classList.contains('light-mode') ? '#ffffff' : '#1f2937';
        sidebar.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
        sidebar.style.padding = '1rem';
        sidebar.style.borderRadius = '0.5rem';
    } else {
        sidebar.style.position = '';
        sidebar.style.top = '';
        sidebar.style.right = '';
        sidebar.style.width = '';
        sidebar.style.maxWidth = '';
        sidebar.style.zIndex = '';
        sidebar.style.backgroundColor = '';
        sidebar.style.boxShadow = '';
        sidebar.style.padding = '';
        sidebar.style.borderRadius = '';
    }
}

// Update sidebar position on scroll
window.addEventListener('scroll', () => {
    const sidebar = document.getElementById('sidebar');
    const header = document.querySelector('header');
    const headerRect = header.getBoundingClientRect();

    if (sidebar.classList.contains('active')) {
        sidebar.style.top = `${headerRect.bottom + window.pageYOffset}px`;
    }
});

// Hamburger menu toggle
document.getElementById('hamburger-menu').addEventListener('click', toggleSidebar);

// Sidebar toggle button
document.getElementById('sidebar-toggle').addEventListener('click', toggleSidebar);

// Sidebar close button
document.getElementById('sidebar-close').addEventListener('click', () => {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.add('hidden');
    sidebar.classList.remove('active');
    sidebar.style.position = '';
    sidebar.style.top = '';
    sidebar.style.right = '';
    sidebar.style.width = '';
    sidebar.style.maxWidth = '';
    sidebar.style.zIndex = '';
    sidebar.style.backgroundColor = '';
    sidebar.style.boxShadow = '';
    sidebar.style.padding = '';
    sidebar.style.borderRadius = '';
});

// Theme toggle
document.getElementById('theme-toggle').addEventListener('click', () => {
    document.body.classList.toggle('light-mode');
    const icon = document.getElementById('theme-toggle');
    icon.textContent = document.body.classList.contains('light-mode') ? 'ðŸŒž' : 'ðŸŒ™';
});

// Advanced search with autocomplete
const searchInput = document.getElementById('search-input');
const searchLoading = document.getElementById('search-loading');
searchInput.addEventListener('input', debounce(() => {
    const query = searchInput.value.trim().toLowerCase();
    searchLoading.classList.remove('hidden');
    searchContainer.classList.add('hidden');
    setTimeout(() => {
        document.querySelectorAll('.artist-card').forEach(card => {
            const artistName = card.querySelector('h3').textContent.toLowerCase();
            card.classList.toggle('hidden', query && !artistName.includes(query));
        });
        if (query) {
            const suggestions = getSearchSuggestions(query);
            displaySearchSuggestions(suggestions);
        } else {
            searchContainer.innerHTML = '';
            searchContainer.classList.add('hidden');
        }
        searchLoading.classList.add('hidden');
    }, 500);
}, 300));

function getSearchSuggestions(query) {
    const suggestions = [];
    Object.keys(artistSongs).forEach(artist => {
        const artistName = document.querySelector(`.artist-card[data-artist="${artist}"] h3`)?.textContent || artist;
        if (artistName.toLowerCase().includes(query)) {
            suggestions.push({ type: 'artist', name: artistName, id: artist });
        }
        artistSongs[artist].forEach(song => {
            if (song.title.toLowerCase().includes(query)) {
                suggestions.push({ type: 'song', name: song.title, artist: artistName, id: artist });
            }
        });
    });
    return suggestions.slice(0, 5); // Limit to 5 suggestions
}

function displaySearchSuggestions(suggestions) {
    searchContainer.innerHTML = '';
    if (suggestions.length) {
        suggestions.forEach(suggestion => {
            const div = document.createElement('div');
            div.className = 'p-2 hover:bg-gray-700 cursor-pointer text-gray-300 light-mode:text-gray-800 light-mode:hover:bg-gray-200';
            div.textContent = suggestion.type === 'artist' ? suggestion.name : `${suggestion.name} - ${suggestion.artist}`;
            div.addEventListener('click', () => {
                if (suggestion.type === 'artist') {
                    const artistCard = document.querySelector(`.artist-card[data-artist="${suggestion.id}"]`);
                    artistCard.click();
                } else {
                    currentPlaylist = artistSongs[suggestion.id];
                    currentTrackIndex = artistSongs[suggestion.id].findIndex(song => song.title === suggestion.name);
                    playTrack(currentPlaylist[currentTrackIndex], suggestion.artist);
                    updateQueue(suggestion.artist);
                }
                searchInput.value = '';
                searchContainer.innerHTML = '';
                searchContainer.classList.add('hidden');
            });
            searchContainer.appendChild(div);
        });
        searchContainer.classList.remove('hidden');
    }
}

// Debounce function to limit search input rate
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Load more/less functionality for artists
document.getElementById('load-more').addEventListener('click', () => {
    document.querySelectorAll('.artist-grid .artist-card.hidden').forEach(card => {
        card.classList.remove('hidden');
    });
    document.getElementById('load-more').classList.add('hidden');
    document.getElementById('load-less').classList.remove('hidden');
});

document.getElementById('load-less').addEventListener('click', () => {
    document.querySelectorAll('.artist-grid .artist-card[data-artist="ehsankhajehamiri"], .artist-grid .artist-card[data-artist="rezasadeghi"], .artist-grid .artist-card[data-artist="sirvankhosravi"], .artist-grid .artist-card[data-artist="benyaminbahadori"], .artist-grid .artist-card[data-artist="farzadfarzin"], .artist-grid .artist-card[data-artist="maziarfallahi"], .artist-grid .artist-card[data-artist="mehdi_yarrahi"], .artist-grid .artist-card[data-artist="aliabdolmaleki"], .artist-grid .artist-card[data-artist="babakjahanbakhsh"], .artist-grid .artist-card[data-artist="mortezapashaei"], .artist-grid .artist-card[data-artist="behnambani"]').forEach(card => {
        card.classList.add('hidden');
    });
    document.getElementById('load-more').classList.remove('hidden');
    document.getElementById('load-less').classList.add('hidden');
});

// Load more/less functionality for languages
document.getElementById('load-more-languages').addEventListener('click', () => {
    document.querySelectorAll('.language-grid .language-card.hidden').forEach(card => {
        card.classList.remove('hidden');
    });
    document.getElementById('load-more-languages').classList.add('hidden');
    document.getElementById('load-less-languages').classList.remove('hidden');
});

document.getElementById('load-less-languages').addEventListener('click', () => {
    document.querySelectorAll('.language-grid .language-card').forEach(card => {
        const language = card.querySelector('a').getAttribute('href').split('/')[1].replace('.html', '');
        if (['spanish', 'french', 'german', 'russian', 'japanese', 'korean', 'chinese', 'italian', 'portuguese', 'urdu', 'bengali', 'swahili', 'tamil', 'thai'].includes(language)) {
            card.classList.add('hidden');
        }
    });
    document.getElementById('load-more-languages').classList.remove('hidden');
    document.getElementById('load-less-languages').classList.add('hidden');
});

// Load more/less functionality for local artists
document.getElementById('load-more-local').addEventListener('click', () => {
    document.querySelectorAll('.local-artist-grid .artist-card.hidden').forEach(card => {
        card.classList.remove('hidden');
    });
    document.getElementById('load-more-local').classList.add('hidden');
    document.getElementById('load-less-local').classList.remove('hidden');
});

document.getElementById('load-less-local').addEventListener('click', () => {
    document.querySelectorAll('.local-artist-grid .artist-card[data-artist="azari"], .local-artist-grid .artist-card[data-artist="khorasani"], .local-artist-grid .artist-card[data-artist="kermani"], .local-artist-grid .artist-card[data-artist="sistani"], .local-artist-grid .artist-card[data-artist="yazdi"], .local-artist-grid .artist-card[data-artist="esfahani"], .local-artist-grid .artist-card[data-artist="bakhtiari"]').forEach(card => {
        card.classList.add('hidden');
    });
    document.getElementById('load-more-local').classList.remove('hidden');
    document.getElementById('load-less-local').classList.add('hidden');
});

// Load more/less functionality for qari
document.getElementById('load-more-qari').addEventListener('click', () => {
    document.querySelectorAll('.qari-grid .language-card.hidden').forEach(card => {
        card.classList.remove('hidden');
    });
    document.getElementById('load-more-qari').classList.add('hidden');
    document.getElementById('load-less-qari').classList.remove('hidden');
});

document.getElementById('load-less-qari').addEventListener('click', () => {
    document.querySelectorAll('.qari-grid .language-card').forEach(card => {
        const qari = card.querySelector('a').getAttribute('href').split('/')[1].replace('.html', '');
        if (['sudais', 'shuraim', 'ghamidi', 'ayyub', 'husary'].includes(qari)) {
            card.classList.add('hidden');
        }
    });
    document.getElementById('load-more-qari').classList.remove('hidden');
    document.getElementById('load-less-qari').classList.add('hidden');
});

// Artist card click handler
document.querySelectorAll('.artist-card').forEach(card => {
    card.addEventListener('click', (e) => {
        if (e.target.tagName !== 'A') {
            const artist = card.getAttribute('data-artist');
            const artistName = card.querySelector('h3').textContent;
            if (artistSongs[artist]) {
                currentPlaylist = [...artistSongs[artist]]; // Create a copy to allow modifications
                currentTrackIndex = 0;
                currentArtistName = artistName;
                playTrack(currentPlaylist[currentTrackIndex], artistName);
                updateQueue(artistName);
                savePlayerState();
            }
        }
    });
});

// Music player controls
const playPauseBtn = document.getElementById('play-pause-btn');
playPauseBtn.addEventListener('click', () => {
    togglePlayPause();
});

function togglePlayPause() {
    const isPlaying = playPauseBtn.textContent === 'Ù¾Ø®Ø´';
    playPauseBtn.textContent = isPlaying ? 'ØªÙˆÙ‚Ù' : 'Ù¾Ø®Ø´';
    if (isPlaying) {
        audio.play().catch(showError);
    } else {
        audio.pause();
    }
    savePlayerState();
}

document.getElementById('prev-btn').addEventListener('click', () => {
    if (currentTrackIndex > 0) {
        currentTrackIndex--;
        playTrack(currentPlaylist[currentTrackIndex], currentArtistName);
    }
});

document.getElementById('next-btn').addEventListener('click', () => {
    if (currentTrackIndex < currentPlaylist.length - 1) {
        currentTrackIndex++;
        playTrack(currentPlaylist[currentTrackIndex], currentArtistName);
    }
});

document.getElementById('queue-toggle').addEventListener('click', () => {
    document.getElementById('queue-list').classList.toggle('active');
});

// Handle track end
audio.addEventListener('ended', () => {
    if (currentTrackIndex < currentPlaylist.length - 1) {
        currentTrackIndex++;
        playTrack(currentPlaylist[currentTrackIndex], currentArtistName);
    } else {
        playPauseBtn.textContent = 'Ù¾Ø®Ø´';
        audio.currentTime = 0;
        savePlayerState();
    }
});

// Progress bar update
audio.addEventListener('timeupdate', () => {
    const progressBar = document.getElementById('progress-bar');
    const currentTime = document.getElementById('current-time');
    const totalTime = document.getElementById('total-time');
    if (!isNaN(audio.duration)) {
        progressBar.value = (audio.currentTime / audio.duration) * 100;
        currentTime.textContent = formatTime(audio.currentTime);
        totalTime.textContent = formatTime(audio.duration);
        savePlayerState();
    }
});

document.getElementById('progress-bar').addEventListener('input', (e) => {
    const seekTime = (e.target.value / 100) * audio.duration;
    audio.currentTime = seekTime;
    savePlayerState();
});

// Drag-and-drop for queue
function setupQueueDragAndDrop() {
    const queueItems = document.getElementById('queue-items');
    queueItems.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', e.target.dataset.index);
        e.target.classList.add('dragging');
    });
    queueItems.addEventListener('dragend', (e) => {
        e.target.classList.remove('dragging');
    });
    queueItems.addEventListener('dragover', (e) => {
        e.preventDefault();
    });
    queueItems.addEventListener('drop', (e) => {
        e.preventDefault();
        const draggedIndex = parseInt(e.dataTransfer.getData('text/plain'));
        const dropIndex = Array.from(queueItems.children).indexOf(e.target.closest('.queue-item'));
        if (draggedIndex !== dropIndex) {
            const [draggedItem] = currentPlaylist.splice(draggedIndex, 1);
            currentPlaylist.splice(dropIndex, 0, draggedItem);
            updateQueue(currentArtistName);
            if (draggedIndex === currentTrackIndex) {
                currentTrackIndex = dropIndex;
            } else if (draggedIndex < currentTrackIndex && dropIndex >= currentTrackIndex) {
                currentTrackIndex--;
            } else if (draggedIndex > currentTrackIndex && dropIndex <= currentTrackIndex) {
                currentTrackIndex++;
            }
            savePlayerState();
        }
    });
}

// Play track with error handling
function playTrack(track, artistName) {
    audio.src = track.src;
    audio.load();
    document.getElementById('player-title').textContent = track.title;
    document.getElementById('player-artist').textContent = artistName;
    document.getElementById('player-art').src = track.art;
    audio.play().then(() => {
        playPauseBtn.textContent = 'ØªÙˆÙ‚Ù';
    }).catch(showError);
    savePlayerState();
}

// Update queue with drag-and-drop and remove functionality
function updateQueue(artistName) {
    const queueItems = document.getElementById('queue-items');
    queueItems.innerHTML = '';
    currentPlaylist.forEach((track, index) => {
        const li = document.createElement('li');
        li.className = 'queue-item flex justify-between items-center';
        li.draggable = true;
        li.dataset.index = index;
        li.innerHTML = `
            <span>${track.title} - ${artistName}</span>
            <button class="remove-track text-red-500 hover:text-red-700">âœ•</button>
        `;
        li.querySelector('.remove-track').addEventListener('click', () => {
            currentPlaylist.splice(index, 1);
            if (index < currentTrackIndex) {
                currentTrackIndex--;
            } else if (index === currentTrackIndex && currentPlaylist.length > 0) {
                currentTrackIndex = Math.min(currentTrackIndex, currentPlaylist.length - 1);
                playTrack(currentPlaylist[currentTrackIndex], artistName);
            } else if (currentPlaylist.length === 0) {
                audio.pause();
                playPauseBtn.textContent = 'Ù¾Ø®Ø´';
                document.getElementById('player-title').textContent = 'Ø¹Ù†ÙˆØ§Ù† Ø¢Ù‡Ù†Ú¯';
                document.getElementById('player-artist').textContent = 'Ù†Ø§Ù… Ø®ÙˆØ§Ù†Ù†Ø¯Ù‡';
                document.getElementById('player-art').src = 'https://picsum.photos/seed/default/50/50.jpg';
            }
            updateQueue(artistName);
            savePlayerState();
        });
        li.addEventListener('click', (e) => {
            if (!e.target.classList.contains('remove-track')) {
                currentTrackIndex = index;
                playTrack(currentPlaylist[currentTrackIndex], artistName);
            }
        });
        queueItems.appendChild(li);
    });
    setupQueueDragAndDrop();
}

// Save player state to localStorage
function savePlayerState() {
    const state = {
        playlist: currentPlaylist,
        trackIndex: currentTrackIndex,
        artistName: currentArtistName,
        currentTime: audio.currentTime,
        isPlaying: playPauseBtn.textContent === 'ØªÙˆÙ‚Ù'
    };
    localStorage.setItem('playerState', JSON.stringify(state));
}

// Load player state from localStorage
function loadPlayerState() {
    const state = JSON.parse(localStorage.getItem('playerState'));
    if (state && state.playlist && state.playlist.length) {
        currentPlaylist = state.playlist;
        currentTrackIndex = state.trackIndex;
        currentArtistName = state.artistName;
        playTrack(currentPlaylist[currentTrackIndex], currentArtistName);
        audio.currentTime = state.currentTime;
        if (!state.isPlaying) {
            audio.pause();
            playPauseBtn.textContent = 'Ù¾Ø®Ø´';
        }
    }
}

// Error handling
function showError(error) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'fixed top-4 right-4 bg-red-600 text-white p-4 rounded-lg shadow-lg z-50 animate-pulse';
    errorDiv.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø®Ø´ Ø¢Ù‡Ù†Ú¯: Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.';
    document.body.appendChild(errorDiv);
    setTimeout(() => errorDiv.remove(), 3000);
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    if (e.target === searchInput) return;
    switch (e.key) {
        case ' ':
            e.preventDefault();
            togglePlayPause();
            break;
        case 'ArrowLeft':
            if (currentTrackIndex > 0) {
                currentTrackIndex--;
                playTrack(currentPlaylist[currentTrackIndex], currentArtistName);
            }
            break;
        case 'ArrowRight':
            if (currentTrackIndex < currentPlaylist.length - 1) {
                currentTrackIndex++;
                playTrack(currentPlaylist[currentTrackIndex], currentArtistName);
            }
            break;
    }
});

// Format time
function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    seconds = Math.floor(seconds % 60);
    return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
}